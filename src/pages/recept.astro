---
import Layout from '../layouts/Layout.astro';
import { getCollection } from 'astro:content';

const recipeEntries = await getCollection('recipes');
const recipes = recipeEntries.map((entry: any, index: number) => ({
    id: index + 1,
    name: entry.data.name,
    category: entry.data.category,
    difficulty: entry.data.difficulty,
    time: entry.data.time,
    cookTime: entry.data.cookTime,
    servings: entry.data.servings,
    description: entry.data.description,
    image: entry.data.image,
    slug: entry.slug
}));
---

<Layout
    title="Kotlettrecept - Sveriges B√§sta Samling av Recept p√• Kotlett | Kotlett.se"
    description="Uppt√§ck Sveriges st√∂rsta samling kotlettrecept! Fr√•n klassisk fl√§skkotlett till grillad lammkotlett. Hitta enkla och snabba recept p√• kotlett f√∂r alla tillf√§llen. Steg-f√∂r-steg instruktioner f√∂r perfekt resultat."
>
    <div class="recipe-page">
        <div class="recipe-page-header">
            <h1>Kotlettrecept</h1>
            <p class="subtitle">V√§lkommen till Sveriges mest kompletta samling av kotlettrecept! H√§r hittar du allt fr√•n klassiska kotlettrecept till moderna tolkningar. Oavsett om du s√∂ker recept p√• fl√§skkotlett, lammkotlett eller viltkotlett - vi har kotlettrecept f√∂r alla smaker och tillf√§llen. Fr√•n snabba vardagsrecept till festliga kotlettrecept perfekta f√∂r middag.</p>
            <button class="submit-recipe-btn" id="submitRecipeBtn">
                Skicka in recept
            </button>
        </div>

        <div class="search-bar">
            <input type="text" id="searchInput" class="search-input" placeholder="S√∂k recept...">
            <button class="filter-toggle" id="filterToggle">
                <span class="filter-text">Filter</span>
            </button>
        </div>

        <div class="recipe-layout">
            <aside class="filters-sidebar" id="filtersSidebar">
                <div class="filters-header">
                    <h2 class="filter-title">Filtrera recept</h2>
                    <button class="filters-close" id="filtersClose">‚úï</button>
                </div>

                <div class="filter-group">
                    <label class="filter-label">Typ av kotlett</label>
                    <div class="filter-buttons">
                        <button class="filter-btn active" data-filter="all">Alla</button>
                        <button class="filter-btn" data-filter="flaskkotlett">ü•© Fl√§skkotlett</button>
                        <button class="filter-btn" data-filter="lammkotlett">üêë Lammkotlett</button>
                        <button class="filter-btn" data-filter="kalvkotlett">üêÑ Kalvkotlett</button>
                        <button class="filter-btn" data-filter="notkotlett">ü•© N√∂tkotlett</button>
                        <button class="filter-btn" data-filter="viltkotlett">üêó Viltkotlett</button>
                        <button class="filter-btn" data-filter="fiskkotlett">üêü Fiskkotlett</button>
                        <button class="filter-btn" data-filter="kalkonkotlett">ü¶É Kalkonkotlett</button>
                        <button class="filter-btn" data-filter="ankkotlett">ü¶Ü Ankkotlett</button>
                    </div>
                </div>

                <div class="filter-group">
                    <label class="filter-label">Sv√•righetsgrad</label>
                    <div class="filter-buttons">
                        <button class="filter-btn difficulty active" data-difficulty="all">Alla</button>
                        <button class="filter-btn difficulty" data-difficulty="enkel">Enkel</button>
                        <button class="filter-btn difficulty" data-difficulty="medel">Medel</button>
                        <button class="filter-btn difficulty" data-difficulty="svar">Sv√•r</button>
                    </div>
                </div>

                <div class="filter-group">
                    <label class="filter-label">Tillagningstid</label>
                    <div class="filter-buttons">
                        <button class="filter-btn time active" data-time="all">Alla</button>
                        <button class="filter-btn time" data-time="snabb">‚ö° Under 30 min</button>
                        <button class="filter-btn time" data-time="medel">üïê 30-60 min</button>
                        <button class="filter-btn time" data-time="lang">üïêüïê √ñver 60 min</button>
                    </div>
                </div>
            </aside>

            <aside class="recipe-submit-panel" id="recipeSubmitPanel">
                <div class="panel-header">
                    <h2 class="panel-title">Skicka in ditt recept</h2>
                    <button class="panel-close" id="panelClose">‚úï</button>
                </div>

                <div id="form-message-recipe" class="form-message hidden"></div>

                <form
                    name="recipe-submission"
                    method="POST"
                    data-netlify="true"
                    netlify-honeypot="bot-field"
                    class="recipe-form"
                    id="recipeSubmitForm"
                >
                    <input type="hidden" name="form-name" value="recipe-submission" />
                    <p class="hidden">
                        <label>
                            Don't fill this out if you're human: <input name="bot-field" />
                        </label>
                    </p>

                    <div class="form-group">
                        <label for="recipe-name">Receptets namn *</label>
                        <input
                            type="text"
                            id="recipe-name"
                            name="recipe-name"
                            required
                            placeholder="T.ex. Grillad lammkotlett med vitl√∂k"
                        />
                    </div>

                    <div class="form-group">
                        <label for="recipe-category">Typ av kotlett *</label>
                        <select id="recipe-category" name="recipe-category" required>
                            <option value="">V√§lj typ...</option>
                            <option value="flaskkotlett">Fl√§skkotlett</option>
                            <option value="lammkotlett">Lammkotlett</option>
                            <option value="kalvkotlett">Kalvkotlett</option>
                            <option value="notkotlett">N√∂tkotlett</option>
                            <option value="viltkotlett">Viltkotlett</option>
                            <option value="fiskkotlett">Fiskkotlett</option>
                        </select>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label for="recipe-difficulty">Sv√•righetsgrad *</label>
                            <select id="recipe-difficulty" name="recipe-difficulty" required>
                                <option value="">V√§lj...</option>
                                <option value="enkel">Enkel</option>
                                <option value="medel">Medel</option>
                                <option value="svar">Sv√•r</option>
                            </select>
                        </div>

                        <div class="form-group">
                            <label for="recipe-time">Tillagningstid *</label>
                            <select id="recipe-time" name="recipe-time" required>
                                <option value="">V√§lj...</option>
                                <option value="snabb">Snabb (&lt;30 min)</option>
                                <option value="medel">Medel (30-60 min)</option>
                                <option value="lang">L√•ng (&gt;60 min)</option>
                            </select>
                        </div>
                    </div>

                    <div class="form-group">
                        <label for="recipe-servings">Antal portioner *</label>
                        <input
                            type="number"
                            id="recipe-servings"
                            name="recipe-servings"
                            required
                            min="1"
                            max="20"
                            placeholder="4"
                        />
                    </div>

                    <div class="form-group">
                        <label for="recipe-description">Kort beskrivning *</label>
                        <textarea
                            id="recipe-description"
                            name="recipe-description"
                            rows="3"
                            required
                            placeholder="En kort beskrivning av ditt recept..."
                        ></textarea>
                    </div>

                    <div class="form-group">
                        <label for="recipe-ingredients">Ingredienser *</label>
                        <textarea
                            id="recipe-ingredients"
                            name="recipe-ingredients"
                            rows="8"
                            required
                            placeholder="Lista alla ingredienser, en per rad...&#10;&#10;Exempel:&#10;4 kotletter&#10;2 msk sm√∂r&#10;Salt och peppar"
                        ></textarea>
                    </div>

                    <div class="form-group">
                        <label for="recipe-instructions">Instruktioner *</label>
                        <textarea
                            id="recipe-instructions"
                            name="recipe-instructions"
                            rows="10"
                            required
                            placeholder="Beskriv steg-f√∂r-steg hur man lagar r√§tten..."
                        ></textarea>
                    </div>

                    <div class="form-group">
                        <label for="recipe-submitter-name">Ditt namn *</label>
                        <input
                            type="text"
                            id="recipe-submitter-name"
                            name="submitter-name"
                            required
                            placeholder="Ditt namn"
                        />
                    </div>

                    <button type="submit" class="submit-btn">
                        Skicka in recept
                    </button>

                    <p class="form-note">
                        * = Obligatoriskt f√§lt. Vi granskar alla inskick innan publicering.
                    </p>
                </form>
            </aside>

            <div class="recipe-page-content">
                <section class="recipes">
                    <div class="recipe-count">
                        <p><span id="recipeCount">0</span> recept hittades</p>
                    </div>

                    <div class="recipe-grid" id="recipeGrid">
                    <!-- Recipes will be dynamically inserted here -->
                    <div class="no-recipes">
                        <div class="empty-icon">ü•©</div>
                        <p class="empty-message">Inga recept hittades med dessa filter.</p>
                        <p class="empty-submessage">Prova att √§ndra dina filtreringsval!</p>
                    </div>
                </div>
            </section>
        </div>
        </div>
    </div>
</Layout>

<script is:inline define:vars={{ recipes }}>
    // Recipe data loaded from markdown files

    let activeFilters = {
        categories: [],
        difficulties: [],
        times: [],
        search: ''
    };

    function renderRecipes() {
        const grid = document.getElementById('recipeGrid');
        const count = document.getElementById('recipeCount');

        if (!grid || !count) return;

        const filtered = recipes.filter(recipe => {
            const categoryMatch = activeFilters.categories.length === 0 || activeFilters.categories.includes(recipe.category);
            const difficultyMatch = activeFilters.difficulties.length === 0 || activeFilters.difficulties.includes(recipe.difficulty);
            const timeMatch = activeFilters.times.length === 0 || activeFilters.times.includes(recipe.time);
            const searchMatch = activeFilters.search === '' ||
                recipe.name.toLowerCase().includes(activeFilters.search.toLowerCase()) ||
                recipe.description.toLowerCase().includes(activeFilters.search.toLowerCase());

            return categoryMatch && difficultyMatch && timeMatch && searchMatch;
        });

        count.textContent = filtered.length.toString();

        if (filtered.length === 0) {
            grid.innerHTML = `
                <div class="no-recipes">
                    <div class="empty-icon">ü•©</div>
                    <p class="empty-message">Inga recept hittades med dessa filter.</p>
                    <p class="empty-submessage">Prova att √§ndra dina filtreringsval!</p>
                </div>
            `;
            return;
        }

        grid.innerHTML = filtered.map(recipe => `
            <div class="recipe-card">
                <div class="recipe-header">
                    <div class="recipe-icon">${recipe.image}</div>
                    <h3 class="recipe-name">${recipe.name}</h3>
                </div>
                <p class="recipe-description">${recipe.description}</p>
                <div class="recipe-meta">
                    <span class="meta-item">‚è±Ô∏è ${recipe.cookTime}</span>
                    <span class="meta-item">üë• ${recipe.servings} port.</span>
                    <span class="meta-item difficulty-badge ${recipe.difficulty}">${recipe.difficulty}</span>
                </div>
                <div class="recipe-actions">
                    <a href="/recept/${recipe.slug}" class="recipe-btn">Se recept</a>
                </div>
            </div>
        `).join('');
    }

    document.addEventListener('DOMContentLoaded', () => {
        // Initial render
        renderRecipes();

        // Category filters
        const categoryBtns = document.querySelectorAll('.filter-btn[data-filter]');
        categoryBtns.forEach(btn => {
            btn.addEventListener('click', () => {
                const filter = btn.dataset.filter;
                if (filter === 'all') {
                    // Clear all category filters
                    activeFilters.categories = [];
                    categoryBtns.forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');
                } else {
                    // Remove 'all' button active state
                    categoryBtns.forEach(b => {
                        if (b.dataset.filter === 'all') b.classList.remove('active');
                    });
                    // Toggle this filter
                    btn.classList.toggle('active');
                    if (btn.classList.contains('active')) {
                        activeFilters.categories.push(filter);
                    } else {
                        activeFilters.categories = activeFilters.categories.filter(f => f !== filter);
                    }
                    // If no filters selected, activate 'all'
                    if (activeFilters.categories.length === 0) {
                        categoryBtns.forEach(b => {
                            if (b.dataset.filter === 'all') b.classList.add('active');
                        });
                    }
                }
                renderRecipes();
            });
        });

        // Difficulty filters
        const difficultyBtns = document.querySelectorAll('.filter-btn[data-difficulty]');
        difficultyBtns.forEach(btn => {
            btn.addEventListener('click', () => {
                const difficulty = btn.dataset.difficulty;
                if (difficulty === 'all') {
                    activeFilters.difficulties = [];
                    difficultyBtns.forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');
                } else {
                    difficultyBtns.forEach(b => {
                        if (b.dataset.difficulty === 'all') b.classList.remove('active');
                    });
                    btn.classList.toggle('active');
                    if (btn.classList.contains('active')) {
                        activeFilters.difficulties.push(difficulty);
                    } else {
                        activeFilters.difficulties = activeFilters.difficulties.filter(d => d !== difficulty);
                    }
                    if (activeFilters.difficulties.length === 0) {
                        difficultyBtns.forEach(b => {
                            if (b.dataset.difficulty === 'all') b.classList.add('active');
                        });
                    }
                }
                renderRecipes();
            });
        });

        // Time filters
        const timeBtns = document.querySelectorAll('.filter-btn[data-time]');
        timeBtns.forEach(btn => {
            btn.addEventListener('click', () => {
                const time = btn.dataset.time;
                if (time === 'all') {
                    activeFilters.times = [];
                    timeBtns.forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');
                } else {
                    timeBtns.forEach(b => {
                        if (b.dataset.time === 'all') b.classList.remove('active');
                    });
                    btn.classList.toggle('active');
                    if (btn.classList.contains('active')) {
                        activeFilters.times.push(time);
                    } else {
                        activeFilters.times = activeFilters.times.filter(t => t !== time);
                    }
                    if (activeFilters.times.length === 0) {
                        timeBtns.forEach(b => {
                            if (b.dataset.time === 'all') b.classList.add('active');
                        });
                    }
                }
                renderRecipes();
            });
        });

        // Search functionality
        const searchInput = document.getElementById('searchInput');
        if (searchInput) {
            searchInput.addEventListener('input', (e) => {
                const target = e.target;
                if (target && 'value' in target && typeof target.value === 'string') {
                    activeFilters.search = target.value;
                    renderRecipes();
                }
            });
        }

        // Filter toggle for mobile
        const filterToggle = document.getElementById('filterToggle');
        const filtersSidebar = document.getElementById('filtersSidebar');
        const filtersClose = document.getElementById('filtersClose');

        if (filterToggle && filtersSidebar) {
            filterToggle.addEventListener('click', () => {
                filtersSidebar.classList.toggle('active');
            });
        }

        if (filtersClose && filtersSidebar) {
            filtersClose.addEventListener('click', () => {
                filtersSidebar.classList.remove('active');
            });
        }

        // Close sidebar when clicking outside on mobile
        document.addEventListener('click', (e) => {
            const target = e.target;
            if (filtersSidebar && filterToggle && target instanceof Node) {
                if (!filtersSidebar.contains(target) && !filterToggle.contains(target)) {
                    filtersSidebar.classList.remove('active');
                }
            }
        });

        // Recipe submission panel
        const submitRecipeBtn = document.getElementById('submitRecipeBtn');
        const recipeSubmitPanel = document.getElementById('recipeSubmitPanel');
        const panelClose = document.getElementById('panelClose');
        const recipeSubmitForm = document.getElementById('recipeSubmitForm');
        const formMessageRecipe = document.getElementById('form-message-recipe');

        if (submitRecipeBtn && recipeSubmitPanel) {
            submitRecipeBtn.addEventListener('click', () => {
                recipeSubmitPanel.classList.add('active');
            });
        }

        if (panelClose && recipeSubmitPanel) {
            panelClose.addEventListener('click', () => {
                recipeSubmitPanel.classList.remove('active');
            });
        }

        // Close panel when clicking outside
        document.addEventListener('click', (e) => {
            const target = e.target;
            if (recipeSubmitPanel && submitRecipeBtn && target instanceof Node) {
                if (!recipeSubmitPanel.contains(target) && !submitRecipeBtn.contains(target)) {
                    recipeSubmitPanel.classList.remove('active');
                }
            }
        });

        // Handle form submission
        if (recipeSubmitForm && formMessageRecipe) {
            recipeSubmitForm.addEventListener('submit', async (e) => {
                e.preventDefault();

                const formData = new FormData(recipeSubmitForm);
                const submitBtn = recipeSubmitForm.querySelector('.submit-btn');

                if (submitBtn) {
                    submitBtn.disabled = true;
                    submitBtn.textContent = 'Skickar...';
                }

                try {
                    const response = await fetch('/', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                        body: new URLSearchParams(formData).toString(),
                    });

                    if (response.ok) {
                        formMessageRecipe.textContent = '‚úÖ Tack! Ditt recept har skickats in och kommer att granskas.';
                        formMessageRecipe.className = 'form-message success';
                        recipeSubmitForm.reset();
                        formMessageRecipe.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    } else {
                        throw new Error('Form submission failed');
                    }
                } catch (error) {
                    formMessageRecipe.textContent = '‚ùå N√•got gick fel. F√∂rs√∂k igen senare.';
                    formMessageRecipe.className = 'form-message error';
                    formMessageRecipe.scrollIntoView({ behavior: 'smooth', block: 'center' });
                } finally {
                    if (submitBtn) {
                        submitBtn.disabled = false;
                        submitBtn.textContent = 'Skicka in recept';
                    }
                }
            });
        }
    });
</script>
